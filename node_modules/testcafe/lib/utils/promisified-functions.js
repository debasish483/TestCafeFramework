"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = __importDefault(require("child_process"));
const graceful_fs_1 = __importDefault(require("graceful-fs"));
const pinkie_1 = __importDefault(require("pinkie"));
const pngjs_1 = require("pngjs");
const promisify_event_1 = __importDefault(require("promisify-event"));
const promisify_1 = __importDefault(require("./promisify"));
exports.readDir = promisify_1.default(graceful_fs_1.default.readdir);
exports.stat = promisify_1.default(graceful_fs_1.default.stat);
exports.writeFile = promisify_1.default(graceful_fs_1.default.writeFile);
exports.readFile = promisify_1.default(graceful_fs_1.default.readFile);
exports.deleteFile = promisify_1.default(graceful_fs_1.default.unlink);
exports.exec = promisify_1.default(child_process_1.default.exec);
exports.sendMessageToChildProcess = promisify_1.default((process, ...args) => process.send(...args));
function readPng(buffer) {
    const png = new pngjs_1.PNG();
    const parsedPromise = pinkie_1.default.race([
        promisify_event_1.default(png, 'parsed'),
        promisify_event_1.default(png, 'error')
    ]);
    png.parse(buffer);
    return parsedPromise
        .then(() => png);
}
exports.readPng = readPng;
async function readPngFile(filePath) {
    const buffer = await exports.readFile(filePath);
    return await readPng(buffer);
}
exports.readPngFile = readPngFile;
function writePng(filePath, png) {
    const outStream = graceful_fs_1.default.createWriteStream(filePath);
    const pngStream = png.pack();
    const finishPromise = pinkie_1.default.race([
        promisify_event_1.default(outStream, 'finish'),
        promisify_event_1.default(outStream, 'error'),
        promisify_event_1.default(pngStream, 'error')
    ]);
    pngStream.pipe(outStream);
    return finishPromise;
}
exports.writePng = writePng;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvbWlzaWZpZWQtZnVuY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWxzL3Byb21pc2lmaWVkLWZ1bmN0aW9ucy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGtFQUF5QztBQUN6Qyw4REFBNkI7QUFDN0Isb0RBQTZCO0FBQzdCLGlDQUE0QjtBQUM1QixzRUFBNkM7QUFDN0MsNERBQW9DO0FBRXZCLFFBQUEsT0FBTyxHQUFNLG1CQUFTLENBQUMscUJBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQyxRQUFBLElBQUksR0FBUyxtQkFBUyxDQUFDLHFCQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsUUFBQSxTQUFTLEdBQUksbUJBQVMsQ0FBQyxxQkFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3JDLFFBQUEsUUFBUSxHQUFLLG1CQUFTLENBQUMscUJBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNwQyxRQUFBLFVBQVUsR0FBRyxtQkFBUyxDQUFDLHFCQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFFbEMsUUFBQSxJQUFJLEdBQUcsbUJBQVMsQ0FBQyx1QkFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRXBDLFFBQUEseUJBQXlCLEdBQUcsbUJBQVMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7QUFFaEcsU0FBZ0IsT0FBTyxDQUFFLE1BQU07SUFDM0IsTUFBTSxHQUFHLEdBQUcsSUFBSSxXQUFHLEVBQUUsQ0FBQztJQUV0QixNQUFNLGFBQWEsR0FBRyxnQkFBTyxDQUFDLElBQUksQ0FBQztRQUMvQix5QkFBYyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUM7UUFDN0IseUJBQWMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDO0tBQy9CLENBQUMsQ0FBQztJQUVILEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFbEIsT0FBTyxhQUFhO1NBQ2YsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3pCLENBQUM7QUFaRCwwQkFZQztBQUVNLEtBQUssVUFBVSxXQUFXLENBQUUsUUFBUTtJQUN2QyxNQUFNLE1BQU0sR0FBRyxNQUFNLGdCQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFeEMsT0FBTyxNQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqQyxDQUFDO0FBSkQsa0NBSUM7QUFFRCxTQUFnQixRQUFRLENBQUUsUUFBUSxFQUFFLEdBQUc7SUFDbkMsTUFBTSxTQUFTLEdBQUcscUJBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqRCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFFN0IsTUFBTSxhQUFhLEdBQUcsZ0JBQU8sQ0FBQyxJQUFJLENBQUM7UUFDL0IseUJBQWMsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDO1FBQ25DLHlCQUFjLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQztRQUNsQyx5QkFBYyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUM7S0FDckMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUUxQixPQUFPLGFBQWEsQ0FBQztBQUN6QixDQUFDO0FBYkQsNEJBYUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hpbGRQcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IGZzIGZyb20gJ2dyYWNlZnVsLWZzJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgeyBQTkcgfSBmcm9tICdwbmdqcyc7XG5pbXBvcnQgcHJvbWlzaWZ5RXZlbnQgZnJvbSAncHJvbWlzaWZ5LWV2ZW50JztcbmltcG9ydCBwcm9taXNpZnkgZnJvbSAnLi9wcm9taXNpZnknO1xuXG5leHBvcnQgY29uc3QgcmVhZERpciAgICA9IHByb21pc2lmeShmcy5yZWFkZGlyKTtcbmV4cG9ydCBjb25zdCBzdGF0ICAgICAgID0gcHJvbWlzaWZ5KGZzLnN0YXQpO1xuZXhwb3J0IGNvbnN0IHdyaXRlRmlsZSAgPSBwcm9taXNpZnkoZnMud3JpdGVGaWxlKTtcbmV4cG9ydCBjb25zdCByZWFkRmlsZSAgID0gcHJvbWlzaWZ5KGZzLnJlYWRGaWxlKTtcbmV4cG9ydCBjb25zdCBkZWxldGVGaWxlID0gcHJvbWlzaWZ5KGZzLnVubGluayk7XG5cbmV4cG9ydCBjb25zdCBleGVjID0gcHJvbWlzaWZ5KGNoaWxkUHJvY2Vzcy5leGVjKTtcblxuZXhwb3J0IGNvbnN0IHNlbmRNZXNzYWdlVG9DaGlsZFByb2Nlc3MgPSBwcm9taXNpZnkoKHByb2Nlc3MsIC4uLmFyZ3MpID0+IHByb2Nlc3Muc2VuZCguLi5hcmdzKSk7XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkUG5nIChidWZmZXIpIHtcbiAgICBjb25zdCBwbmcgPSBuZXcgUE5HKCk7XG5cbiAgICBjb25zdCBwYXJzZWRQcm9taXNlID0gUHJvbWlzZS5yYWNlKFtcbiAgICAgICAgcHJvbWlzaWZ5RXZlbnQocG5nLCAncGFyc2VkJyksXG4gICAgICAgIHByb21pc2lmeUV2ZW50KHBuZywgJ2Vycm9yJylcbiAgICBdKTtcblxuICAgIHBuZy5wYXJzZShidWZmZXIpO1xuXG4gICAgcmV0dXJuIHBhcnNlZFByb21pc2VcbiAgICAgICAgLnRoZW4oKCkgPT4gcG5nKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlYWRQbmdGaWxlIChmaWxlUGF0aCkge1xuICAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IHJlYWRGaWxlKGZpbGVQYXRoKTtcblxuICAgIHJldHVybiBhd2FpdCByZWFkUG5nKGJ1ZmZlcik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cml0ZVBuZyAoZmlsZVBhdGgsIHBuZykge1xuICAgIGNvbnN0IG91dFN0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGZpbGVQYXRoKTtcbiAgICBjb25zdCBwbmdTdHJlYW0gPSBwbmcucGFjaygpO1xuXG4gICAgY29uc3QgZmluaXNoUHJvbWlzZSA9IFByb21pc2UucmFjZShbXG4gICAgICAgIHByb21pc2lmeUV2ZW50KG91dFN0cmVhbSwgJ2ZpbmlzaCcpLFxuICAgICAgICBwcm9taXNpZnlFdmVudChvdXRTdHJlYW0sICdlcnJvcicpLFxuICAgICAgICBwcm9taXNpZnlFdmVudChwbmdTdHJlYW0sICdlcnJvcicpXG4gICAgXSk7XG5cbiAgICBwbmdTdHJlYW0ucGlwZShvdXRTdHJlYW0pO1xuXG4gICAgcmV0dXJuIGZpbmlzaFByb21pc2U7XG59XG5cblxuIl19